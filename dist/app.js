var Game=function(){this.utils={timestamp:function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},fpsmeter:new FPSMeter(document.getElementById("fpsmeter"),{decimals:0,graph:!0,theme:"dark",left:"5px"}),springs:{stiffness:700,damping:30,maxLength:7}};var e=this,t=0,s=1/60,o=this.utils.timestamp(),i=[],n=new THREE.Vector2;this.addToGameScene=function(e){a.add(e)},this.removeFromGameScene=function(e){a.remove(e)},this.createBridge=function(t,s){var o,i,n;o=new THREE.LineBasicMaterial({color:10092543}),i=new THREE.Geometry,i.vertices.push(e.objects.showMe[t].mesh.position),i.vertices.push(e.objects.showMe[s].mesh.position),n=new THREE.Line(i,o),e.objects.lines.push({material:o,geometry:i,mesh:n,box1:t,box2:s}),a.add(n)};var a,r,c,h,m,d,l,u,w,p,b,E,y,g,M,v;this.initGameField=function(){a=new THREE.Scene,a.fog=new THREE.Fog(0,0,500),r=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,.1,1e3),r.translateX(0),r.translateY(30),r.translateZ(35),c=new THREE.WebGLRenderer({antialias:!0}),c.shadowMapType=THREE.PCFSoftShadowMap,c.shadowMapEnabled=!0,c.shadowMapSoft=!0,c.setSize(window.innerWidth,window.innerHeight),c.setClearColor(a.fog.color,1),u=new THREE.PlaneBufferGeometry(70,6,50,50),u.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),w=new THREE.MeshLambertMaterial({color:11184810}),p=new THREE.Mesh(u,w),p.position.z=3,p.castShadow=!0,p.receiveShadow=!0,a.add(p),b=new THREE.PlaneBufferGeometry(70,40,50,50),E=new THREE.MeshLambertMaterial({color:13421823}),y=new THREE.Mesh(b,E),y.position.y=20,y.position.z=-.1,y.castShadow=!0,y.receiveShadow=!0,a.add(y),g=new THREE.CylinderGeometry(3,3,.8,32),M=new THREE.MeshLambertMaterial({color:16720469,transparent:!0,opacity:.5}),v=new THREE.Mesh(g,M),v.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),v.position.y=24,a.add(v);var e;e=new THREE.AmbientLight(2236962),a.add(e),h=new THREE.SpotLight(16777215),h.position.set(-15,60,14),h.shadowMapWidth=1024,h.shadowMapHeight=1024,h.shadowCameraNear=10,h.shadowCameraFov=50,h.shadowDarkness=.95,h.intensity=1.6,h.castShadow=!0,a.add(h),m=new THREE.Raycaster},this.initObjects=function(e){this.mySocketId=e.id,this.color=e.color,this.objects={mouseIndicators:{},showMe:[],lines:[],springs:[],obstacles:[]},this.boxGeometry=new THREE.CylinderGeometry(.5,.5,1,8),this.boxGeometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));for(var t=0;t<e.cubes.length;t++){var s=new THREE.MeshLambertMaterial({color:new THREE.Color(e.cubes[t].color)||16777215}),o=new THREE.Mesh(this.boxGeometry,s);o.castShadow=!0,this.objects.showMe.push({mesh:o}),e.cubes[t].position.z=0,this.objects.showMe[t].mesh.position.copy(e.cubes[t].position),this.objects.showMe[t].mesh.quaternion.copy(e.cubes[t].q),this.objects.showMe[t].velocity=e.cubes[t].velocity,a.add(this.objects.showMe[t].mesh)}for(var t=0;t<e.lines.length;t++)this.createBridge(e.lines[t].index1,e.lines[t].index2);var i=new THREE.MeshLambertMaterial({color:new THREE.Color(this.color)}),n=new THREE.Mesh(this.boxGeometry,i);n.castShadow=!0,game.objects.mouseIndicators[this.mySocketId]=n,a.add(game.objects.mouseIndicators[this.mySocketId]),d=!1,l=[],this.nearestCubes=[];for(var t=0;2>=t;t++){var r,c,h;r=new THREE.LineBasicMaterial({color:6750207}),c=new THREE.Geometry,c.vertices.push(new THREE.Vector3(10,0,0)),c.vertices.push(new THREE.Vector3(-10,0,10)),h=new THREE.Line(c,r),this.nearestCubes.push({distance:void 0,index:void 0,line:h}),a.add(this.nearestCubes[t].line)}},this.handleKeyUp=function(e){i[e.keyCode]=!1},this.handleKeyDown=function(e){i[e.keyCode]=!0},this.handleKeys=function(){if(i[13]&&document.getElementById("name").value&&document.getElementById("message").value){var e={name:document.getElementById("name").value,message:document.getElementById("message").value};socket.emit("sendMessage",e),document.getElementById("message").value=""}},this.handleMouseMove=function(e){e.preventDefault(),n.x=e.clientX/window.innerWidth*2-1,n.y=2*-(e.clientY/window.innerHeight)+1},this.handleMouseClick=function(t){if(d&&e.nearestCubes[0].distance<=e.utils.springs.maxLength&&e.nearestCubes[1].distance<=e.utils.springs.maxLength){var s={};s.position=e.objects.mouseIndicators[e.mySocketId].position,s.nearestCubes=[];for(var o=0;o<e.nearestCubes.length;o++)void 0!=e.nearestCubes[o].index&&s.nearestCubes.push({distance:e.nearestCubes[o].distance,index:e.nearestCubes[o].index});socket.emit("newCube",s)}},this.update=function(e){this.handleKeys();var t=[];t.push(y),t.push(v),m.setFromCamera(n,r);var s=m.intersectObjects(t);0!=s.length&&s.length<2?(d=!0,socket.emit("mouseIndicatorMove",{x:s[0].point.x,y:s[0].point.y,z:s[0].point.z}),this.objects.mouseIndicators[this.mySocketId].position.set(s[0].point.x,s[0].point.y,s[0].point.z)):d=!1,this.objects.mouseIndicators[this.mySocketId].visible=d?!0:!1;for(var o=0;o<this.objects.lines.length;o++)this.objects.lines[o].mesh.geometry.verticesNeedUpdate=!0;for(var o=0;o<this.objects.showMe.length;o++){this.objects.showMe[o].mesh.position.x+=this.objects.showMe[o].velocity.x/100,this.objects.showMe[o].mesh.position.y+=this.objects.showMe[o].velocity.y/100,this.objects.showMe[o].mesh.position.y<.5&&(this.objects.showMe[o].mesh.position.y=.5);var i=this.objects.showMe[o].mesh.position.x-this.objects.mouseIndicators[this.mySocketId].position.x,a=this.objects.showMe[o].mesh.position.y-this.objects.mouseIndicators[this.mySocketId].position.y,c=this.objects.showMe[o].mesh.position.z-this.objects.mouseIndicators[this.mySocketId].position.z;l.push(Math.sqrt(i*i+a*a+c*c)),this.objects.showMe[o].mesh.material.transparent=!1}for(var h,u,o=0;2>=o;o++){if(h=_.min(l),u=_.indexOf(l,h),d&&h<=this.utils.springs.maxLength){var w,p,b;w=new THREE.LineBasicMaterial({color:6750207}),p=new THREE.Geometry,p.vertices.push(this.objects.showMe[u].mesh.position),p.vertices.push(game.objects.mouseIndicators[this.mySocketId].position),b=new THREE.Line(p,w),this.nearestCubes[o].line.visible=!0,this.nearestCubes[o].line.geometry.vertices[0].set(this.objects.showMe[u].mesh.position.x,this.objects.showMe[u].mesh.position.y,this.objects.showMe[u].mesh.position.z),this.nearestCubes[o].line.geometry.vertices[1].set(game.objects.mouseIndicators[this.mySocketId].position.x,game.objects.mouseIndicators[this.mySocketId].position.y,game.objects.mouseIndicators[this.mySocketId].position.z),this.nearestCubes[o].line.geometry.verticesNeedUpdate=!0,this.nearestCubes[o].distance=h,this.nearestCubes[o].index=u}else this.nearestCubes[o].line.visible=!1,this.nearestCubes[o].distance=void 0,this.nearestCubes[o].index=void 0;l[u]=1/0}l=[]},this.render=function(){c.render(a,r)},this.frame=function(){for(e.utils.fpsmeter.tickStart(),now=e.utils.timestamp(),t+=Math.min(1,(now-o)/1e3);t>s;)t-=s,e.update(s);e.render(t),o=now,requestAnimationFrame(e.frame)},this.init=function(e){this.initGameField(),this.initObjects(e),m=new THREE.Raycaster,c.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(c.domElement),document.onkeyup=this.handleKeyUp,document.onkeydown=this.handleKeyDown,document.onmousemove=this.handleMouseMove,document.onclick=this.handleMouseClick,this.frame()},this.reset=function(){for(var e=3;e<this.objects.showMe.length;e++)this.removeFromGameScene(this.objects.showMe[e].mesh);for(var e=3;e<this.objects.lines.length;e++)this.removeFromGameScene(this.objects.lines[e].mesh)}},game=new Game,socket=io(location.origin);socket.on("refresh",function(e){game.utils.fpsmeter.tick();for(var t=0;t<game.objects.showMe.length;t++)e.cubes[t].position.z=0,game.objects.showMe[t].velocity=e.cubes[t].velocity,game.objects.showMe[t].mesh.position.copy(e.cubes[t].position),game.objects.showMe[t].mesh.quaternion.copy(e.cubes[t].q)}),socket.on("addCube",function(e){var t=new THREE.MeshLambertMaterial({color:new THREE.Color(e.color)||16777215}),s=new THREE.Mesh(game.boxGeometry,t);s.castShadow=!0,s.position.set(e.position.x,e.position.y,e.position.z),game.addToGameScene(s),game.objects.showMe.push({mesh:s}),game.objects.showMe[game.objects.showMe.length-1].velocity={x:0,y:0,z:0};for(var o=0;o<e.nearestCubes.length;o++)game.createBridge(e.nearestCubes[o].index,game.objects.showMe.length-1)}),socket.on("deleteMouseIndicator",function(e){game.removeFromGameScene(game.objects.mouseIndicators[e]),delete game.objects.mouseIndicators[e]}),socket.on("mouseMoved",function(e){var t=e.mouseIndicator,s=e.id;if(game.objects.mouseIndicators.hasOwnProperty(s))game.objects.mouseIndicators[s].position.set(t.position.x,t.position.y,t.position.z);else{var o=new THREE.MeshLambertMaterial({color:new THREE.Color(t.color),opacity:.5,transparent:!0}),i=new THREE.Mesh(game.boxGeometry,o);i.castShadow=!0,i.position.set(t.position.x,t.position.y,t.position.z),game.objects.mouseIndicators[s]=i,game.addToGameScene(game.objects.mouseIndicators[s])}}),socket.on("initialize",function(e){game.init(e)}),socket.on("reset",function(){location.reload()}),socket.on("receiveMessage",function(e){var t=document.createElement("div"),s=document.createElement("p"),o=document.createTextNode(e.name+": "+e.message);s.appendChild(o),t.appendChild(s),t.style.color=e.color,document.getElementById("messages").insertBefore(t,document.getElementById("messages").firstChild)});