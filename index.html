<html>
	<head>
		<title>My first Three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<!-- <div id="fpsmeter"></div> -->

		<script src="node_modules/three/three.min.js"></script>
		<script src="fps.js"></script>
		<script>

		var Game = function () {
			this.utils = {
				timestamp : function timestamp () {
					return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
				}
			};

			var that        = this,
				dt          = 0,
				step        = 1/60,
				last        = this.utils.timestamp(),
				fpsmeter    = new FPSMeter(document.getElementById('fpsmeter'), { decimals: 0, graph: true, theme: 'dark', left: '5px' }),
				objects     = {
					cubes : []
				},
				pressedKeys = [],
				scene       = new THREE.Scene(),
				camera      = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 1000),
				renderer    = new THREE.WebGLRenderer();

			renderer.shadowMapEnabled = true;
			renderer.shadowMapType = THREE.PCFSoftShadowMap;


			var vatBoxGeometry = new THREE.BoxGeometry(20, 2, 20),
				vatBoxMaterial = new THREE.MeshLambertMaterial({ color : 0xdddddd, side : THREE.DoubleSide }),
				vatBox         = new THREE.Mesh(vatBoxGeometry, vatBoxMaterial);

			vatBox.position.set(0, -20, 0);
			vatBox.receiveShadow = true;

			scene.add(vatBox);


			var spotlight = new THREE.SpotLight(0xffffff);
			spotlight.position.set(0 ,20, 0);
			spotlight.shadowMapWidth      = 1024;
			spotlight.shadowMapHeight     = 1024;
			spotlight.shadowCameraNear    = 10;
			spotlight.shadowCameraFov     = 50;
			spotlight.shadowCameraVisible = true;
			spotlight.target              = vatBox;
			spotlight.shadowDarkness      = 0.95;
			spotlight.intensity           = 1.5;
			spotlight.castShadow          = true;
			scene.add(spotlight);



			var gameBoxGeometry = new THREE.BoxGeometry(50, 50, 50),
				gameBoxMaterial = new THREE.MeshLambertMaterial({ color : 0x669999 , side : THREE.BackSide }),
				gameBox         = new THREE.Mesh(gameBoxGeometry, gameBoxMaterial);

			gameBox.receiveShadow = true;
			scene.add(gameBox);


			var ambientLight    = new THREE.AmbientLight(0x222222);
			scene.add(ambientLight);


			this.handleKeyUp = function (event) {
				pressedKeys[event.keyCode] = false;
			};

			this.handleKeyDown = function (event) {
				pressedKeys[event.keyCode] = true;
			};

			this.handleKeys = function () {
				if (pressedKeys[33]) {
					// Page Up
					z -= 0.05;
				}
				if (pressedKeys[34]) {
					// Page Down
					z += 0.05;
				}
				if (pressedKeys[37]) {
					// Left cursor key
					spotlight.position.x += -0.4;
				}
				if (pressedKeys[39]) {
					// Right cursor key
					spotlight.position.x -= -0.4;
				}
				if (pressedKeys[38]) {
					// Up cursor key
					spotlight.position.z += -0.4;
				}
				if (pressedKeys[40]) {
					// Down cursor key
					spotlight.position.z -= -0.4;
				}
			};

			this.update = function () {

				that.handleKeys();

				for (var i = objects.cubes.length - 1; i >= 0; i--) {
					objects.cubes[i].position.x += objects.cubes[i].direction.x * objects.cubes[i].velocity;
					objects.cubes[i].position.y += objects.cubes[i].direction.x * objects.cubes[i].velocity;
				}
			};

			this.render = function () {
				renderer.render(scene, camera);
			};

			this.frame = function () {
				fpsmeter.tickStart();
				now  = that.utils.timestamp();
				dt   = dt + Math.min(1, (now - last) / 1000);
				while (dt > step) {
					dt = dt - step;
					that.update(step);
					fpsmeter.tick();
				}
				that.render(dt);
				last = now;
				requestAnimationFrame(that.frame);
			};

			this.init = function () {
				renderer.setSize(window.innerWidth, window.innerHeight);

				document.body.appendChild(renderer.domElement);
				document.onkeyup   = this.handleKeyUp;
				document.onkeydown = this.handleKeyDown;

				camera.position.z = 15;
				camera.position.y = 0;

				var geometry        = new THREE.BoxGeometry(1, 1, 1),
					material        = new THREE.MeshPhongMaterial({ color : 0x00ff00 });
				/*var outlineGeometry = new THREE.BoxGeometry(1.1, 1.1, 1.1),
					outlineMaterial = new THREE.MeshBasicMaterial({ color : 0x00ffff, side : THREE.BackSide });*/


				var currentCube;
				/*var currentOutline;*/
				for (var i = 9; i >= 0; i--) {
					currentCube = new THREE.Mesh(geometry, material);
					currentCube.position.set(Math.floor((Math.random() * 11) - 5), Math.floor((Math.random() * 11) - 5), Math.floor((Math.random() * 11) - 5));
					currentCube.castShadow = true;
					currentCube.receiveShadow = true;
					objects.cubes.push(currentCube);
					currentCube.velocity = 0.1;
					currentCube.direction = new THREE.Vector3(1, 1, 1);
					/*currentOutline = new THREE.Mesh(outlineGeometry, outlineMaterial);
					currentOutline.position.set(currentCube.position.x, currentCube.position.y, currentCube.position.z);
					currentCube.scale.multiplyScalar(1.05);
					objects.cubes.push(currentOutline);*/


				}

				for (var i = objects.cubes.length - 1; i >= 0; i--) {
					scene.add(objects.cubes[i]);
				}
				
				
				this.frame();
			};
		};

		var game = new Game();
		game.init();

		</script>
	</body>
</html>