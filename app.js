var Game=function(){this.utils={timestamp:function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},springs:{stiffness:700,damping:30,maxLength:7}};var e=this,t=0,s=1/60,o=this.utils.timestamp(),i=new FPSMeter(document.getElementById("fpsmeter"),{decimals:0,graph:!0,theme:"dark",left:"5px"}),n=[],a=new THREE.Vector2;this.addToGameScene=function(e){r.add(e)},this.removeFromGameScene=function(e){r.remove(e)},this.createBridge=function(t,s){var o,i,n;o=new THREE.LineBasicMaterial({color:10092543}),i=new THREE.Geometry,i.vertices.push(e.objects.showMe[t].mesh.position),i.vertices.push(e.objects.showMe[s].mesh.position),n=new THREE.Line(i,o),e.objects.lines.push({material:o,geometry:i,mesh:n,box1:t,box2:s}),r.add(n)};var r,c,h,m,d,u,l,w,p,b,E,g,M,y,v,f;this.initGameField=function(){r=new THREE.Scene,r.fog=new THREE.Fog(0,0,500),c=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,.1,1e3),c.translateX(0),c.translateY(20),c.translateZ(30),h=new THREE.WebGLRenderer,h.shadowMapType=THREE.PCFSoftShadowMap,h.shadowMapEnabled=!0,h.shadowMapSoft=!0,h.setSize(window.innerWidth,window.innerHeight),h.setClearColor(r.fog.color,1),w=new THREE.PlaneBufferGeometry(70,6,50,50),w.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),p=new THREE.MeshLambertMaterial({color:11184810}),b=new THREE.Mesh(w,p),b.position.z=3,b.castShadow=!0,b.receiveShadow=!0,r.add(b),E=new THREE.PlaneBufferGeometry(70,40,50,50),g=new THREE.MeshLambertMaterial({color:13421823}),M=new THREE.Mesh(E,g),M.position.y=20,M.position.z=-.1,M.castShadow=!0,M.receiveShadow=!0,r.add(M),y=new THREE.CylinderGeometry(3,3,.8,32),v=new THREE.MeshLambertMaterial({color:16720469,transparent:!0,opacity:.5}),f=new THREE.Mesh(y,v),f.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),f.position.y=24,r.add(f);var e;e=new THREE.AmbientLight(2236962),r.add(e),m=new THREE.SpotLight(16777215),m.position.set(-15,60,14),m.shadowMapWidth=1024,m.shadowMapHeight=1024,m.shadowCameraNear=10,m.shadowCameraFov=50,m.shadowDarkness=.95,m.intensity=1.6,m.castShadow=!0,r.add(m),d=new THREE.Raycaster},this.initObjects=function(e){this.mySocketId=e.id,this.color=e.color,this.objects={mouseIndicators:{},showMe:[],lines:[],springs:[],obstacles:[]},this.boxGeometry=new THREE.BoxGeometry(1,1,1);for(var t=0;t<e.cubes.length;t++){var s=new THREE.MeshLambertMaterial({color:new THREE.Color(e.cubes[t].color)||16777215}),o=new THREE.Mesh(this.boxGeometry,s);this.objects.showMe.push({mesh:o}),this.objects.showMe[t].mesh.position.copy(e.cubes[t].position),this.objects.showMe[t].mesh.quaternion.copy(e.cubes[t].q),r.add(this.objects.showMe[t].mesh)}for(var t=0;t<e.lines.length;t++)this.createBridge(e.lines[t].index1,e.lines[t].index2);var i=new THREE.MeshLambertMaterial({color:new THREE.Color(this.color)}),n=new THREE.Mesh(this.boxGeometry,i);game.objects.mouseIndicators[this.mySocketId]=n,r.add(game.objects.mouseIndicators[this.mySocketId]),u=!1,l=[],this.nearestCubes=[];for(var t=0;2>=t;t++){var a,c,h;a=new THREE.LineBasicMaterial({color:6750207}),c=new THREE.Geometry,c.vertices.push(new THREE.Vector3(10,0,0)),c.vertices.push(new THREE.Vector3(-10,0,10)),h=new THREE.Line(c,a),this.nearestCubes.push({distance:void 0,index:void 0,line:h}),r.add(this.nearestCubes[t].line)}},this.handleKeyUp=function(e){n[e.keyCode]=!1},this.handleKeyDown=function(e){n[e.keyCode]=!0},this.handleKeys=function(){n[32]&&socket.emit("reset")},this.handleMouseMove=function(e){e.preventDefault(),a.x=e.clientX/window.innerWidth*2-1,a.y=2*-(e.clientY/window.innerHeight)+1},this.handleMouseClick=function(t){if(u&&e.nearestCubes[0].distance<=e.utils.springs.maxLength&&e.nearestCubes[1].distance<=e.utils.springs.maxLength){var s={};s.position=e.objects.mouseIndicators[e.mySocketId].position,s.nearestCubes=[];for(var o=0;o<e.nearestCubes.length;o++)void 0!=e.nearestCubes[o].index&&s.nearestCubes.push({distance:e.nearestCubes[o].distance,index:e.nearestCubes[o].index});socket.emit("newCube",s)}},this.update=function(e){this.handleKeys();var t=[];t.push(M),t.push(f),d.setFromCamera(a,c);var s=d.intersectObjects(t);0!=s.length&&s.length<2?(u=!0,socket.emit("mouseIndicatorMove",{x:s[0].point.x,y:s[0].point.y,z:s[0].point.z}),this.objects.mouseIndicators[this.mySocketId].position.set(s[0].point.x,s[0].point.y,s[0].point.z)):u=!1,this.objects.mouseIndicators[this.mySocketId].visible=u?!0:!1;for(var o=0;o<this.objects.lines.length;o++)this.objects.lines[o].mesh.geometry.verticesNeedUpdate=!0;for(var o=0;o<this.objects.showMe.length;o++){var i=this.objects.showMe[o].mesh.position.x-this.objects.mouseIndicators[this.mySocketId].position.x,n=this.objects.showMe[o].mesh.position.y-this.objects.mouseIndicators[this.mySocketId].position.y,r=this.objects.showMe[o].mesh.position.z-this.objects.mouseIndicators[this.mySocketId].position.z;l.push(Math.sqrt(i*i+n*n+r*r)),this.objects.showMe[o].mesh.material.transparent=!1}for(var h,m,o=0;2>=o;o++){if(h=_.min(l),m=_.indexOf(l,h),u&&h<=this.utils.springs.maxLength){var w,p,b;w=new THREE.LineBasicMaterial({color:6750207}),p=new THREE.Geometry,p.vertices.push(this.objects.showMe[m].mesh.position),p.vertices.push(game.objects.mouseIndicators[this.mySocketId].position),b=new THREE.Line(p,w),this.nearestCubes[o].line.visible=!0,this.nearestCubes[o].line.geometry.vertices[0].set(this.objects.showMe[m].mesh.position.x,this.objects.showMe[m].mesh.position.y,this.objects.showMe[m].mesh.position.z),this.nearestCubes[o].line.geometry.vertices[1].set(game.objects.mouseIndicators[this.mySocketId].position.x,game.objects.mouseIndicators[this.mySocketId].position.y,game.objects.mouseIndicators[this.mySocketId].position.z),this.nearestCubes[o].line.geometry.verticesNeedUpdate=!0,this.nearestCubes[o].distance=h,this.nearestCubes[o].index=m}else this.nearestCubes[o].line.visible=!1,this.nearestCubes[o].distance=void 0,this.nearestCubes[o].index=void 0;l[m]=1/0}l=[]},this.render=function(){h.render(r,c)},this.frame=function(){for(i.tickStart(),now=e.utils.timestamp(),t+=Math.min(1,(now-o)/1e3);t>s;)t-=s,e.update(s),i.tick();e.render(t),o=now,requestAnimationFrame(e.frame)},this.init=function(e){this.initGameField(),this.initObjects(e),d=new THREE.Raycaster,h.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(h.domElement),document.onkeyup=this.handleKeyUp,document.onkeydown=this.handleKeyDown,document.onmousemove=this.handleMouseMove,document.onclick=this.handleMouseClick,this.frame()},this.reset=function(){for(var e=3;e<this.objects.showMe.length;e++)this.removeFromGameScene(this.objects.showMe[e].mesh);for(var e=3;e<this.objects.lines.length;e++)this.removeFromGameScene(this.objects.lines[e].mesh)}},game=new Game,socket=io(location.origin);socket.on("refresh",function(e){for(var t=0;t<game.objects.showMe.length;t++)game.objects.showMe[t].mesh.position.copy(e.cubes[t].position),game.objects.showMe[t].mesh.quaternion.copy(e.cubes[t].q)}),socket.on("addCube",function(e){var t=new THREE.MeshLambertMaterial({color:new THREE.Color(e.color)||16777215}),s=new THREE.Mesh(game.boxGeometry,t);s.position.set(e.position.x,e.position.y,e.position.z),game.addToGameScene(s),game.objects.showMe.push({mesh:s});for(var o=0;o<e.nearestCubes.length;o++)game.createBridge(e.nearestCubes[o].index,game.objects.showMe.length-1)}),socket.on("deleteMouseIndicator",function(e){game.removeFromGameScene(game.objects.mouseIndicators[e]),delete game.objects.mouseIndicators[e]}),socket.on("mouseMoved",function(e){var t=e.mouseIndicator,s=e.id;if(game.objects.mouseIndicators.hasOwnProperty(s))game.objects.mouseIndicators[s].position.set(t.position.x,t.position.y,t.position.z),game.objects.mouseIndicators[s].material.color=new THREE.Color(t.color),game.objects.mouseIndicators[s].material.transparent=!0,game.objects.mouseIndicators[s].material.opacity=.5;else{var o=new THREE.MeshLambertMaterial({color:new THREE.Color(t.color),opacity:.5,transparent:!0}),i=new THREE.Mesh(game.boxGeometry,o);i.position.set(t.position.x,t.position.y,t.position.z),game.objects.mouseIndicators[s]=i,game.addToGameScene(game.objects.mouseIndicators[s])}}),socket.on("initialize",function(e){game.init(e)}),socket.on("reset",function(){location.reload()});